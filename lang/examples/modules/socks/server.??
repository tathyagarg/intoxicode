@all
@import("fs")
@import("socket")
@import("http")

fun get_root() {
  throwaway "This is the home page"
}

fd = socket ~ socket(socket ~ AF_INET, socket ~ SOCK_STREAM, 0)
socket ~ bind(fd, "127.0.0.1", 8000)
socket ~ listen(fd, 10)
scream("Listening\n")

loop (true) {
  client = socket ~ accept(fd, "", 1, 2)

  client_msg = ""
  fs ~ read(client, client_msg, 200)

  request = http ~ request_from_data(client_msg)

  scream("Data: \n", client_msg, "\n\n")

  scream("Method ", request ~ method, "\n")
  scream("URL ", request ~ url, "\n")
  scream("Protocol ", request ~ protocol, "\n")

  repeat i to length(request ~ headers) {
    scream("Header ", i + 1, ":\n  - Name: ", ((request ~ headers)[i]) ~ name, "\n  - Value: ", ((request ~ headers)[i]) ~ value, "\n")
  }

  # scream("Headers ", request ~ headers, "\n")
  scream("Body ", request ~ body, "\n")

  fs ~ write(client, "Meow")
}
